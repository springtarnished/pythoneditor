<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Python Code Runner</title>
  <!-- CodeMirror for better code editing -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/theme/dracula.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/theme/eclipse.min.css">
  <style>
    :root {
      --bg-color: #f4f4f4;
      --text-color: #333;
      --card-bg: #fff;
      --border-color: #ddd;
      --button-color: #007bff;
      --button-hover: #0056b3;
      --tab-active: #e7f0ff;
      --tab-hover: #f0f8ff;
    }

    .dark-mode {
      --bg-color: #222;
      --text-color: #eee;
      --card-bg: #333;
      --border-color: #555;
      --button-color: #0066cc;
      --button-hover: #004499;
      --tab-active: #2a3b50;
      --tab-hover: #1e2e42;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: var(--bg-color);
      color: var(--text-color);
      transition: all 0.3s ease;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 28px;
      margin-left: 10px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:checked + .slider:before {
      transform: translateX(32px);
    }

    .CodeMirror {
      height: 300px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 14px;
    }

    .control-panel {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      background: var(--button-color);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    button:hover {
      background: var(--button-hover);
    }

    button:disabled {
      background: #999;
      cursor: not-allowed;
    }

    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .output-container {
      margin-top: 20px;
      background: var(--card-bg);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .visualization-container {
      margin-top: 20px;
      background: var(--card-bg);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      display: none;
    }

    .output {
      white-space: pre-wrap;
      font-family: 'Courier New', Courier, monospace;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }

    #stdout {
      background: #f8f9fa;
      color: #212529;
    }

    .dark-mode #stdout {
      background: #292d3e;
      color: #eee;
    }

    #stderr {
      background: #fff8f8;
      color: #d63031;
    }

    .dark-mode #stderr {
      background: #3c2a2a;
      color: #ff6b6b;
    }

    .label {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .templates-dropdown {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
    }

    /* Tabs styles */
    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      border: 1px solid transparent;
      border-bottom: none;
      margin-right: 2px;
      transition: all 0.2s ease;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab.active {
      background-color: var(--tab-active);
      border-color: var(--border-color);
      border-bottom-color: transparent;
    }

    .tab:hover:not(.active) {
      background-color: var(--tab-hover);
    }

    .tab-close {
      margin-left: 5px;
      font-size: 14px;
      opacity: 0.7;
    }

    .tab-close:hover {
      opacity: 1;
    }

    .add-tab {
      padding: 8px 12px;
      font-size: 14px;
      margin-left: 10px;
    }

    /* History panel */
    .history-panel {
      position: fixed;
      right: -350px;
      top: 0;
      width: 350px;
      height: 100%;
      background: var(--card-bg);
      transition: right 0.3s ease;
      z-index: 100;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
      overflow-y: auto;
      padding: 20px;
    }

    .history-panel.open {
      right: 0;
    }

    .history-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
    }

    .history-item {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .history-item:hover {
      background: var(--tab-hover);
    }

    .history-timestamp {
      font-size: 12px;
      color: #888;
    }

    .history-code {
      margin-top: 5px;
      font-family: monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 12px;
    }

    /* Stats panel */
    .stats {
      display: flex;
      margin-top: 10px;
      font-size: 14px;
      gap: 15px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .plot-container {
      width: 100%;
      height: 400px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      overflow: hidden;
      background: #fff;
    }

    #plot-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .control-panel {
        flex-direction: column;
      }
      
      button, .templates-dropdown {
        width: 100%;
      }

      .tabs {
        overflow-x: auto;
        padding-bottom: 5px;
      }

      .history-panel {
        width: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>Python Code Runner</h2>
    <div class="theme-toggle">
      <span>Dark Mode</span>
      <label class="switch">
        <input type="checkbox" id="theme-toggle">
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <!-- Tabs for multiple files -->
  <div class="tabs" id="file-tabs">
    <div class="tab active" data-id="main.py">main.py</div>
    <button class="add-tab" onclick="addNewFile()">+ New File</button>
  </div>

  <div id="editor-container"></div>
  
  <div class="control-panel">
    <button id="run-button" onclick="runCode()">Run Code</button>
    <button onclick="clearOutput()">Clear Output</button>
    <button onclick="toggleVisualization()">Toggle Visualization</button>
    <button onclick="toggleHistory()">History</button>
    <select class="templates-dropdown" onchange="loadTemplate(this.value)">
      <option value="">-- Select Template --</option>
      <option value="hello">Hello World</option>
      <option value="math">Math Operations</option>
      <option value="list">List Operations</option>
      <option value="file">File I/O</option>
      <option value="web">Simple Web Request</option>
      <option value="visualization">Matplotlib Visualization</option>
    </select>
  </div>

  <div class="output-container">
    <div class="label">Output:</div>
    <div id="stdout" class="output"></div>
    <div class="label">Error:</div>
    <div id="stderr" class="output"></div>
    <div class="stats">
      <div class="stat-item">
        <span>Execution Time:</span>
        <span id="execution-time">-</span>
      </div>
      <div class="stat-item">
        <span>Memory Usage:</span>
        <span id="memory-usage">-</span>
      </div>
    </div>
  </div>

  <!-- Visualization Container -->
  <div class="visualization-container" id="visualization-container">
    <div class="label">Visualization:</div>
    <div class="plot-container">
      <iframe id="plot-frame" title="Plot Output"></iframe>
    </div>
  </div>

  <!-- History Panel -->
  <div class="history-panel" id="history-panel">
    <span class="history-close" onclick="toggleHistory()">&times;</span>
    <h3>Code History</h3>
    <div id="history-items">
      <!-- History items will be added here dynamically -->
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.3/mode/python/python.min.js"></script>
  <script>
    // Templates
    const templates = {
      hello: 'print("Hello, World!")\n\n# Try changing the message above\nname = input("What is your name? ")\nprint(f"Hello, {name}!")',
      math: '# Basic math operations\nx = 10\ny = 5\n\nprint(f"Addition: {x + y}")\nprint(f"Subtraction: {x - y}")\nprint(f"Multiplication: {x * y}")\nprint(f"Division: {x / y}")\nprint(f"Power: {x ** y}")',
      list: '# List operations\nfruits = ["apple", "banana", "cherry"]\n\nprint("Original list:", fruits)\n\n# Add an item\nfruits.append("orange")\nprint("After append:", fruits)\n\n# Remove an item\nfruits.remove("banana")\nprint("After remove:", fruits)\n\n# Loop through the list\nprint("\\nLooping through the list:")\nfor fruit in fruits:\n    print(f"- {fruit}")',
      file: '# File operations\n\n# Create a file\nwith open("test.txt", "w") as f:\n    f.write("Hello, this is a test file.\\n")\n    f.write("This is the second line.\\n")\n    f.write("This is the third line.\\n")\n\nprint("File created successfully!")\n\n# Read the file\nprint("\\nReading the file:")\nwith open("test.txt", "r") as f:\n    content = f.read()\n    print(content)',
      web: '# Simple web request\nimport requests\n\nresponse = requests.get("https://jsonplaceholder.typicode.com/todos/1")\ndata = response.json()\n\nprint("Response status:", response.status_code)\nprint("Response data:", data)',
      visualization: '# Matplotlib visualization\nimport matplotlib.pyplot as plt\nimport numpy as np\n\n# Generate data\nx = np.linspace(0, 10, 100)\ny = np.sin(x)\n\n# Create plot\nplt.figure(figsize=(10, 6))\nplt.plot(x, y, "b-", linewidth=2, label="sin(x)")\nplt.title("Sine Wave")\nplt.xlabel("x")\nplt.ylabel("sin(x)")\nplt.grid(True)\nplt.legend()\n\n# Save to an image file that the backend will serve\nplt.savefig("plot.png")\nplt.close()\n\nprint("Plot generated successfully!")'
    };

    // Initialize CodeMirror
    const editor = CodeMirror(document.getElementById("editor-container"), {
      mode: "python",
      theme: "eclipse",
      lineNumbers: true,
      indentUnit: 4,
      tabSize: 4,
      indentWithTabs: false,
      smartIndent: true,
      extraKeys: {
        "Ctrl-Enter": function() { runCode(); },
        "Cmd-Enter": function() { runCode(); }
      },
      value: 'print("Hello, Android!")'
    });

    // Store all files
    let files = {
      "main.py": 'print("Hello, Android!")'
    };
    let currentFile = "main.py";

    // Theme toggling
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('change', function() {
      document.body.classList.toggle('dark-mode');
      if (this.checked) {
        editor.setOption('theme', 'dracula');
      } else {
        editor.setOption('theme', 'eclipse');
      }
      localStorage.setItem('darkMode', this.checked);
    });

    // Load dark mode preference from localStorage
    if (localStorage.getItem('darkMode') === 'true') {
      themeToggle.checked = true;
      document.body.classList.add('dark-mode');
      editor.setOption('theme', 'dracula');
    }

    // File management functions
    function addNewFile() {
      const fileName = prompt("Enter file name (must end with .py):");
      if (!fileName) return;
      
      if (!fileName.endsWith('.py')) {
        alert("File name must end with .py");
        return;
      }
      
      if (files[fileName]) {
        alert("File already exists!");
        return;
      }
      
      // Save current file content
      files[currentFile] = editor.getValue();
      
      // Create new file
      files[fileName] = '# New file: ' + fileName + '\n\nprint("This is ' + fileName + '")';
      
      // Add new tab
      addTab(fileName);
      
      // Switch to new file
      switchFile(fileName);
    }

    function addTab(fileName) {
      const tabsContainer = document.getElementById('file-tabs');
      const newTab = document.createElement('div');
      newTab.className = 'tab';
      newTab.dataset.id = fileName;
      newTab.innerHTML = fileName + '<span class="tab-close" onclick="closeFile(event, \'' + fileName + '\')">&times;</span>';
      newTab.addEventListener('click', (e) => {
        if (e.target.className !== 'tab-close') {
          switchFile(fileName);
        }
      });
      
      // Insert before the add button
      tabsContainer.insertBefore(newTab, document.querySelector('.add-tab'));
    }

    function switchFile(fileName) {
      // Save current file content
      files[currentFile] = editor.getValue();
      
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Add active class to selected tab
      document.querySelector(`.tab[data-id="${fileName}"]`).classList.add('active');
      
      // Set editor content to selected file
      editor.setValue(files[fileName]);
      
      // Update current file
      currentFile = fileName;
    }

    function closeFile(event, fileName) {
      event.stopPropagation();
      
      // Cannot close the last file
      if (Object.keys(files).length <= 1) {
        alert("Cannot close the last file.");
        return;
      }
      
      // Confirm before closing
      if (!confirm(`Close ${fileName}? Any unsaved changes will be lost.`)) {
        return;
      }
      
      // Remove tab
      const tab = document.querySelector(`.tab[data-id="${fileName}"]`);
      tab.remove();
      
      // Remove file from files object
      delete files[fileName];
      
      // If closing the current file, switch to the first file
      if (fileName === currentFile) {
        const firstFileName = Object.keys(files)[0];
        switchFile(firstFileName);
      }
    }

    // Load templates
    function loadTemplate(template) {
      if (template && templates[template]) {
        editor.setValue(templates[template]);
      }
    }

    // Clear output
    function clearOutput() {
      document.getElementById("stdout").textContent = "";
      document.getElementById("stderr").textContent = "";
      document.getElementById("execution-time").textContent = "-";
      document.getElementById("memory-usage").textContent = "-";
      document.getElementById("visualization-container").style.display = "none";
    }

    // Toggle visualization container
    function toggleVisualization() {
      const container = document.getElementById("visualization-container");
      if (container.style.display === "none" || container.style.display === "") {
        container.style.display = "block";
      } else {
        container.style.display = "none";
      }
    }

    // Toggle history panel
    function toggleHistory() {
      const panel = document.getElementById("history-panel");
      panel.classList.toggle("open");
      
      // Load history items if panel is opening
      if (panel.classList.contains("open")) {
        loadHistoryItems();
      }
    }

    // Load history items from localStorage
    function loadHistoryItems() {
      const historyContainer = document.getElementById("history-items");
      historyContainer.innerHTML = "";
      
      // Get history from localStorage
      const history = JSON.parse(localStorage.getItem("codeHistory") || "[]");
      
      if (history.length === 0) {
        historyContainer.innerHTML = "<p>No history yet.</p>";
        return;
      }
      
      // Add each item to the container
      history.forEach((item, index) => {
        const historyItem = document.createElement("div");
        historyItem.className = "history-item";
        historyItem.onclick = () => loadFromHistory(item);
        
        const timestamp = document.createElement("div");
        timestamp.className = "history-timestamp";
        timestamp.textContent = new Date(item.timestamp).toLocaleString();
        
        const code = document.createElement("div");
        code.className = "history-code";
        code.textContent = item.code.substring(0, 100) + (item.code.length > 100 ? "..." : "");
        
        historyItem.appendChild(timestamp);
        historyItem.appendChild(code);
        historyContainer.appendChild(historyItem);
      });
    }

    // Load code from history
    function loadFromHistory(item) {
      // Ask to save current changes
      if (confirm("Load code from history? Current changes will be replaced.")) {
        editor.setValue(item.code);
        toggleHistory(); // Close history panel
      }
    }

    // Add to history
    function addToHistory(code, result) {
      // Get existing history
      const history = JSON.parse(localStorage.getItem("codeHistory") || "[]");
      
      // Add new item
      history.unshift({
        code: code,
        result: {
          output: result.output,
          error: result.error,
          execution_time: result.execution_time
        },
        timestamp: new Date().getTime()
      });
      
      // Keep only the last 20 items
      if (history.length > 20) {
        history.pop();
      }
      
      // Save back to localStorage
      localStorage.setItem("codeHistory", JSON.stringify(history));
    }

    // Run code
    async function runCode() {
      const runButton = document.getElementById("run-button");
      runButton.disabled = true;
      runButton.innerHTML = '<span class="spinner"></span> Running...';
      
      clearOutput();
      
      // Save all files first
      files[currentFile] = editor.getValue();
      
      // Prepare files object for backend
      const filesToSend = {};
      for (const [name, content] of Object.entries(files)) {
        filesToSend[name] = content;
      }
      
      try {
        const res = await fetch("https://your-backend.up.railway.app/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            code: files[currentFile],
            main_file: currentFile,
            files: filesToSend
          })
        });

        const data = await res.json();
        document.getElementById("stdout").textContent = data.output || "";
        document.getElementById("stderr").textContent = data.error || "";
        document.getElementById("execution-time").textContent = 
          data.execution_time ? `${data.execution_time.toFixed(2)}s` : "-";
        document.getElementById("memory-usage").textContent = 
          data.memory_usage ? `${(data.memory_usage / (1024 * 1024)).toFixed(2)} MB` : "-";
        
        // Check if there's a plot image
        if (data.has_plot) {
          document.getElementById("visualization-container").style.display = "block";
          const timestamp = new Date().getTime(); // Cache-busting
          document.getElementById("plot-frame").src = 
            `https://your-backend.up.railway.app/plot/${timestamp}`;
        }
        
        // Add to history
        addToHistory(files[currentFile], data);
        
      } catch (error) {
        document.getElementById("stderr").textContent = `Failed to connect to server: ${error.message}`;
      } finally {
        runButton.disabled = false;
        runButton.innerHTML = 'Run Code';
      }
    }

    // Initialize with a keyboard shortcut hint
    document.getElementById("stdout").textContent = "Ready to run code. Press Ctrl+Enter or click 'Run Code' to execute.";
    
    // Add event listeners for tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const fileName = tab.dataset.id;
        switchFile(fileName);
      });
    });
  </script>
</body>
</html>
